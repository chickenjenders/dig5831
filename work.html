<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Infernal Affairs - Shift Scheduler</title>
  <style>
    body {
      background: linear-gradient(135deg, #1a1625, #2d1b3d);
      color: #e0e0e0;
      font-family: 'Inter', sans-serif;
      margin: 0;
      overflow-x: hidden;
    }

    header {
      background: #0f0a1a;
      border-bottom: 2px solid #8b5cf6;
      padding: 20px 40px;
      box-shadow: 0 4px 20px rgba(139, 92, 246, 0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    h1 {
      color: #c084fc;
      font-size: 22px;
    }

    .container {
      display: grid;
      grid-template-columns: 250px 1fr 300px;
      gap: 20px;
      padding: 30px;
    }

    /* Sidebar */
    .demon-list {
      background: rgba(15, 10, 26, 0.6);
      border: 1px solid rgba(139, 92, 246, 0.2);
      border-radius: 10px;
      padding: 15px;
      height: fit-content;
    }

    .demon-item {
      background: rgba(139, 92, 246, 0.1);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: 0.2s;
    }

    .demon-item:hover {
      background: rgba(139, 92, 246, 0.25);
    }

    .demon-item.locked {
      opacity: 0.5;
      cursor: not-allowed;
      position: relative;
    }

    .demon-item.locked::after {
      content: 'ðŸ”’';
      position: absolute;
      right: 10px;
      top: 10px;
      font-size: 14px;
    }

    /* Schedule Area */
    .schedule-area {
      background: rgba(15, 10, 26, 0.6);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 12px;
      padding: 25px;
    }

    .shifts {
      display: flex;
      justify-content: space-between;
      gap: 16px;
    }

    .shift-column {
      flex: 1;
      background: rgba(139, 92, 246, 0.05);
      border-radius: 8px;
      padding: 16px;
      border: 1px solid rgba(139, 92, 246, 0.3);
    }

    .shift-column h3 {
      text-align: center;
      color: #c084fc;
      margin-bottom: 12px;
    }

    .task-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .task-item {
      background: rgba(139, 92, 246, 0.15);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 6px;
      padding: 10px;
      font-size: 14px;
    }

    .drop-slot {
      border: 2px dashed rgba(139, 92, 246, 0.3);
      border-radius: 6px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #9ca3af;
      cursor: pointer;
      transition: 0.2s;
    }

    .drop-slot.drag-over {
      border-color: #c084fc;
      background: rgba(139, 92, 246, 0.1);
    }

    .drop-slot.filled {
      background: rgba(139, 92, 246, 0.2);
      border-color: #8b5cf6;
      color: #fff;
    }

    /* Task Pool */
    .task-pool {
      background: rgba(15, 10, 26, 0.6);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 10px;
      padding: 20px;
      height: fit-content;
    }

    .pool-task {
      background: rgba(139, 92, 246, 0.15);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 10px;
      cursor: move;
      font-size: 13px;
    }

    .pool-task.used {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* Submit Bar */
    .submit-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: rgba(15, 10, 26, 0.9);
      border-top: 2px solid #8b5cf6;
      text-align: center;
      padding: 15px;
    }

    .submit-btn {
      background: linear-gradient(135deg, #8b5cf6, #c084fc);
      border: none;
      border-radius: 6px;
      color: #fff;
      padding: 12px 40px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.3s;
    }

    .submit-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .submit-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 0 20px rgba(139, 92, 246, 0.5);
    }

    /* Modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: #1e1b2e;
      border: 2px solid #8b5cf6;
      border-radius: 12px;
      padding: 30px;
      width: 400px;
      text-align: center;
    }

    /* vertical schedule list and insertion marker */
    .task-list-vertical {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 12px;
      max-width: 720px;
      margin: 0 auto;
    }

    .task-item.baseline {
      padding: 10px 12px;
      background: rgba(139, 92, 246, 0.12);
      border-radius: 6px;
    }

    .task-item.assigned-task {
      background: linear-gradient(90deg, rgba(139, 92, 246, 0.16), rgba(139, 92, 246, 0.22));
      border-radius: 6px;
      padding: 10px 12px;
      cursor: move;
    }

    .insertion-marker {
      height: 8px;
      background: rgba(192, 132, 252, 0.25);
      border-radius: 4px;
      margin: 4px 0;
      transition: all 140ms ease;
      transform-origin: left center;
    }

    .toast {
      position: fixed;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      bottom: 28px;
      background: rgba(30, 27, 46, 0.95);
      color: #e9e4ff;
      border: 1px solid rgba(139, 92, 246, 0.4);
      padding: 10px 16px;
      border-radius: 8px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.5);
      opacity: 0;
      pointer-events: none;
      transition: opacity 180ms ease, transform 180ms ease;
      z-index: 1200;
    }

    .toast.active {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
      pointer-events: auto;
    }

    /* Profile card shown above the schedule when a demon is selected */
    .profile-card {
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(139, 92, 246, 0.08);
      padding: 10px 12px;
      border-radius: 8px;
      margin: 12px 0;
      color: #e7def8;
      text-align: center;
    }

    .profile-item {
      background: rgba(139, 92, 246, 0.06);
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 13px;
      color: #f3e9ff;
    }

    /* layout for profile on the left and tasks on the right */
    .schedule-grid {
      display: grid;
      grid-template-columns: 260px 1fr;
      gap: 18px;
      align-items: start;
      margin-top: 8px;
    }

    .profile-column {
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
    }

    .profile-image {
      position: relative;
      overflow: hidden;
      width: 140px;
      height: 140px;
      border-radius: 8px;
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.16), rgba(192, 132, 252, 0.08));
      border: 1px solid rgba(139, 92, 246, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #f3e9ff;
      font-weight: 700;
      font-size: 18px;
    }

    .profile-image img.profile-photo {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center center;
      display: block;
    }

    /* variant for slightly smaller source images (centered) */
    .profile-image img.small-photo {
      position: absolute;
      width: 92% !important;
      height: 92% !important;
      left: 50% !important;
      top: 50% !important;
      transform: translate(-50%, -50%) !important;
      /* show the full image without cropping */
      object-fit: contain;
      object-position: center center;
      display: block;
      background-color: transparent;
    }

    .profile-bio {
      font-size: 13px;
      color: #dcd0f8;
      background: rgba(255, 255, 255, 0.02);
      padding: 8px;
      border-radius: 6px;
      text-align: left;
    }

    /* Email app styles */
    .app-icons {
      margin-right: 8px;
      position: absolute;
      right: 18px;
      top: 12px;
      z-index: 1500;
    }

    .app-icons button {
      background: transparent;
      border: none;
      color: #e6ddff;
      cursor: pointer;
      padding: 6px 8px;
      border-radius: 6px;
      position: relative;
    }

    .app-icons button:hover {
      background: rgba(139, 92, 246, 0.08);
    }

    .email-inbox {
      position: fixed;
      right: 20px;
      bottom: 20px;
      width: 720px;
      height: 72vh;
      min-height: 420px;
      background: linear-gradient(180deg, #161226, #211730);
      border: 1px solid rgba(139, 92, 246, 0.35);
      border-radius: 10px;
      box-shadow: 0 20px 60px rgba(10, 8, 18, 0.7);
      display: none;
      flex-direction: column;
      z-index: 1400;
      overflow: hidden;
    }

    .email-content {
      display: flex;
      flex: 1;
      min-height: 0;
    }

    .email-inbox-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(139, 92, 246, 0.06);
      color: #e6ddff;
      background: linear-gradient(90deg, rgba(139, 92, 246, 0.03), transparent);
      width: 100%;
      box-sizing: border-box;
    }

    .email-list {
      padding: 10px;
      overflow: auto;
      width: 36%;
      border-right: 1px solid rgba(139, 92, 246, 0.04);
      box-sizing: border-box;
    }

    .email-preview {
      padding: 18px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.01), transparent);
      display: block;
      width: 64%;
      box-sizing: border-box;
      overflow: auto;
    }

    .email-item {
      padding: 10px 12px;
      border-radius: 6px;
      margin-bottom: 8px;
      background: transparent;
      cursor: pointer;
    }

    .email-item:hover {
      background: rgba(139, 92, 246, 0.06);
    }

    .email-item.unread {
      box-shadow: inset 3px 0 0 0 #c084fc;
    }

    .email-item.selected {
      background: rgba(139, 92, 246, 0.08);
    }

    .email-item div {
      line-height: 1.1
    }

    .unread-badge {
      position: absolute;
      top: -6px;
      right: -6px;
      background: #ef4444;
      color: white;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      font-weight: 700;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
    }

    /* resize handle */
    .resize-handle {
      width: 18px;
      height: 18px;
      position: absolute;
      right: 8px;
      bottom: 8px;
      cursor: nwse-resize;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.03), transparent);
      border-radius: 4px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      z-index: 1600;
    }

    /* unread badge pulse animation */
    @keyframes pulse-badge {
      0% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
      }

      70% {
        transform: scale(1.12);
        box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
      }

      100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
      }
    }

    .unread-badge.pulse {
      animation: pulse-badge 1200ms ease-in-out 3;
    }

    /* small incoming notification popup */
    .mail-notify {
      position: fixed;
      right: 26px;
      bottom: 110px;
      background: linear-gradient(180deg, #2b2338, #1d1726);
      color: #fff;
      border: 1px solid rgba(139, 92, 246, 0.25);
      padding: 10px 14px;
      border-radius: 8px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      z-index: 1600;
      opacity: 0;
      transform: translateY(6px);
      transition: opacity 220ms ease, transform 220ms ease;
      max-width: 320px;
      font-size: 13px;
    }

    .mail-notify.show {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>

<body>
  <header>
    <h1>Infernal Affairs â€” Demon Shift Scheduler</h1>
  </header>

  <div class="app-icons" aria-hidden="true">
    <button id="emailIcon" title="Open Mail" aria-label="Open Mail" style="font-size:18px;position:relative;">ðŸ“§ <span
        id="unreadBadge" class="unread-badge" aria-hidden="true" style="display:none">0</span></button>
  </div>

  <div class="container">
    <div class="demon-list" id="demonList"></div>
    <div class="schedule-area" id="scheduleArea">
      <p style="color:#9ca3af; text-align:center;">Select a demon to view schedule</p>
    </div>
    <div class="task-pool" id="taskPool"></div>
  </div>

  <div class="submit-bar">
    <button class="submit-btn" id="submitBtn" disabled>Submit Schedule</button>
  </div>

  <div class="modal" id="modal">
    <div class="modal-content">
      <h2 id="modalTitle" style="color:#c084fc"></h2>
      <p id="modalBody"></p>
      <button class="submit-btn" onclick="closeModal()">Close</button>
    </div>
  </div>

  <!-- Welcome / instructions modal shown on page load -->
  <div class="modal" id="welcomeModal">
    <div class="modal-content">
      <h2 style="color:#c084fc">Welcome to Infernal Affairs</h2>
      <p style="color:#e0e0e0; text-align:left;">Your job: assign one optional task to each of the three shifts for the
        selected demon.<br><br>
        How to play:
      <ul style="text-align:left; color:#d1c0f8;">
        <li>Choose a demon from the left.</li>
        <li>Drag an optional task from the right into the single empty slot for each shift.</li>
        <li>Fill all three slots to enable the Submit button and view the shift report.</li>
      </ul>
      </p>
      <label style="display:flex;align-items:center;gap:8px;justify-content:center;margin-top:8px;color:#cfc1ff;"><input
          type="checkbox" id="hideWelcomeCheckbox"> Don't show this again</label>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:center;">
        <button class="submit-btn" onclick="closeWelcomeModal()">Got it</button>
      </div>
    </div>
  </div>

  <!-- toast element for brief messages -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- small mail notification -->
  <div id="mailNotify" class="mail-notify" aria-hidden="true"></div>

  <!-- Email Inbox (hidden until opened) -->
  <div class="email-inbox" id="emailInbox" role="dialog" aria-modal="false" aria-hidden="true">
    <div class="email-inbox-header">
      <strong>Inbox</strong>
      <div style="display:flex;gap:8px;align-items:center;">
        <button id="composeBtn" class="submit-btn" style="padding:6px 10px;font-size:13px;">New</button>
        <button id="closeEmail" class="submit-btn" style="padding:6px 10px;font-size:13px;">Close</button>
      </div>
    </div>
    <div class="email-content">
      <div class="email-list" id="emailList" tabindex="0"></div>
      <div class="email-preview" id="emailPreview" aria-hidden="true">
        <div id="previewHeader" style="font-weight:700;margin-bottom:6px"></div>
        <div id="previewBody" style="color:#dcd0f8;font-size:14px"></div>
      </div>
    </div>
    <div class="resize-handle" id="resizeHandle" title="Drag to resize" aria-hidden="true"></div>
  </div>

  <script>
    const demons = [
      { id: 'gerald', name: 'Gerald Finch', dept: 'IT', baseline: ['Answer IT ticket emails', 'Attend standup meeting', 'Update the new updates article nobody reads', 'Clean up legacy code', 'Review bug tickets'], optional: ['Attend to 12 tickets for demons needing assistance restarting their computer', 'Unplug and replug HR departmentâ€™s printers (27)', 'Review code project merge requests with no comments', 'Complete mandatory internet safety training', 'Write a 10-page report on why the Wi-Fi crashed last week', 'Train an intern to close tabs (there are 187 open)'], misery: [9, 7, 10, 8, 7, 10], causeOfDeath: 'Fell asleep at the wheel after working 3 days consecutively', sentence: 'Sold soul for middle management position', bloodType: 'A+', mbti: 'ISTJ', astro: 'Virgo', aspects: ['Low patience', 'Arrogant', 'Hates ambiguity'], bio: 'Seasoned systems engineer who values order and predictability. Gets frustrated by vague requirements and loves tidy dashboards.', photo: 'cecil.png' },
      { id: 'cheryl', name: 'Cheryl Stone', dept: 'Sales', baseline: ['Strategy meeting with team', 'Answer emails', 'Review recent contracts', 'Follow up on potential clients', 'Organize new client leads'], optional: ['Data entry in silence', 'Reorganize files alphabetically', 'Complete Manipulation training until reaching a perfect score', 'Solo shift at the crossroads', 'Shadow the new hireâ€™s first soul deal', 'Present quarterly projections to an empty conference room for â€œpractice.â€'], misery: [10, 8, 6, 10, 4, 10], causeOfDeath: 'Old age', sentence: 'Sold soul in exchange for ex-husbandâ€™s fortune', bloodType: 'O-', mbti: 'ENFP', astro: 'Leo', aspects: ['Charismatic', 'People-pleaser', 'Hates to be alone'], bio: 'A persuasive closer who thrives on attention and validation. Loves social rituals but crumbles when isolated.', photo: 'raquel.png' },
      { id: 'marcus', name: 'Marcus Webb', dept: 'HR', baseline: ['Review incoming applicants', 'Conduct second stage interviews', 'Deny PTO requests', 'Complete mandatory customer service training', 'Respond to all emails'], optional: ['Announce new decaf policy in the break room', 'Hold handling meeting for coworkers causing disruption during work', 'Update 200 outdated policies that no one reads', 'Organize a grief circle for demons demoted to Floor 404', 'Address all complaints from the complaint box by assuming who made the complaints', 'Prepare 100 laminated â€œTeamwork is Eternalâ€ posters'], misery: [10, 10, 6, 8, 10, 5], causeOfDeath: 'Got in between violent argument of two coworkers', sentence: 'Contributed nothing to society', bloodType: 'B+', mbti: 'INFJ', astro: 'Capricorn', aspects: ['Overly formal', 'Rule-oriented', 'Hates conflict and confrontation'], bio: 'HR veteran with a rigid rulebook. Loves procedures and quietly feels bad about hard decisions.', photo: 'jeffrey.png' }
    ];


    let state = { current: null, assignments: {}, locked: {} };

    function init() {
      const list = document.getElementById('demonList');
      demons.forEach(d => {
        const el = document.createElement('div');
        el.className = 'demon-item';
        el.innerHTML = `<strong>${d.name}</strong><br><small>${d.dept}</small>`;
        el.onclick = () => selectDemon(d.id);
        list.appendChild(el);
      });
      // show welcome on first load unless hidden
      if (localStorage.getItem('hideWelcome') !== 'true') showWelcomeModal();
    }

    function selectDemon(id) {
      if (state.locked[id]) return;
      state.current = demons.find(d => d.id === id);
      renderSchedule();
      renderTasks();
      document.getElementById('submitBtn').disabled = true;
    }

    function renderSchedule() {
      const d = state.current; const area = document.getElementById('scheduleArea');
      // Build a small profile card with helpful context for the player
      // Build a left-column profile (image + bio + details) and right-side task list
      area.innerHTML = `
        <h2 style='color:#c084fc;text-align:center;'>${d.name} â€” ${d.dept}</h2>
        <div class="schedule-grid">
          <div class="profile-column">
              <div class="profile-image" aria-hidden="true">
                  <img class="profile-photo ${d.id === 'gerald' ? 'small-photo' : ''}" src="${d.photo || ''}" alt="${d.name}" onerror="this.style.display='none'" />
                </div>
              </div>
            <div class="profile-card" style="width:100%; text-align:left;">
              <div class="profile-bio">${d.bio}</div>
              <div style="display:flex;flex-direction:column;gap:6px;margin-top:8px;">
                <div class="profile-item"><strong>Cause:</strong> ${d.causeOfDeath}</div>
                <div class="profile-item"><strong>Sentence:</strong> ${d.sentence}</div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px;">
                  <div class="profile-item"><strong>Blood:</strong> ${d.bloodType}</div>
                  <div class="profile-item"><strong>MBTI:</strong> ${d.mbti}</div>
                  <div class="profile-item"><strong>Astro:</strong> ${d.astro}</div>
                </div>
                <div style="margin-top:6px;" class="profile-item"><strong>Aspects:</strong> ${d.aspects.join(', ')}</div>
              </div>
            </div>
          </div>
          <div class="tasks-column">
            <div class='task-list-vertical' id='scheduleList'>
              ${d.baseline.map((t, i) => `<div class='task-item baseline' data-baseline-index='${i}'>${t}</div>`).join('')}
            </div>
            <p style='text-align:center;color:#9ca3af;margin-top:8px;'>Drag up to 3 optional tasks from the right into the list above. Drop between items to insert.</p>
          </div>
        </div>`;

      // Attach drag/drop listeners to the schedule list container
      const scheduleList = document.getElementById('scheduleList');
      scheduleList.ondragover = listDragOver;
      scheduleList.ondrop = listDrop;
      scheduleList.ondragleave = listDragLeave;

      // restore any previously-saved assignments for this demon
      const saved = state.assignments[d.id] || [];
      saved.forEach(idx => {
        const poolTask = document.querySelector(`.pool-task[data-index='${idx}']`);
        // if poolTask not yet rendered, we'll mark used after renderTasks runs
      });
    }

    function renderTasks() {
      const pool = document.getElementById('taskPool');
      const d = state.current; pool.innerHTML = '<h3>Optional Tasks</h3>';
      d.optional.forEach((t, i) => {
        const el = document.createElement('div');
        el.className = 'pool-task'; el.textContent = t;
        el.draggable = true; el.dataset.index = i;
        el.ondragstart = dragStart;
        el.tabIndex = 0;
        el.onkeydown = poolKeyDown;
        pool.appendChild(el);
      });
      // allow dropping back into the pool to unassign tasks
      pool.ondragover = (e) => e.preventDefault();
      pool.ondrop = dropToPool;
      // mark any pool items used by current assignments
      markPoolUsed();
      // also restore assigned elements in order
      const scheduleList = document.getElementById('scheduleList');
      if (scheduleList) {
        // remove any existing assigned-task elements
        Array.from(scheduleList.querySelectorAll('.assigned-task')).forEach(a => a.remove());
        const saved = state.assignments[state.current.id] || [];
        saved.forEach(idx => {
          const t = d.optional[idx];
          if (t == null) return;
          const newEl = document.createElement('div');
          newEl.className = 'task-item assigned-task';
          newEl.textContent = t;
          newEl.draggable = true;
          newEl.dataset.index = idx;
          newEl.tabIndex = 0;
          newEl.onkeydown = assignedKeyDown;
          newEl.ondragstart = dragStart;
          newEl.ondragend = dragEnd;
          // animate restoration of saved assigned items
          newEl.style.opacity = 0; newEl.style.transform = 'translateY(6px)';
          scheduleList.appendChild(newEl);
          requestAnimationFrame(() => { newEl.style.transition = 'opacity 160ms ease, transform 160ms ease'; newEl.style.opacity = 1; newEl.style.transform = ''; });
        });
        checkReady();
      }
    }

    let dragged = null; // the element being dragged
    let dragSource = null; // 'pool' or 'assigned'
    let insertionMarker = null;

    function ensureMarker() {
      if (!insertionMarker) {
        insertionMarker = document.createElement('div');
        insertionMarker.className = 'insertion-marker';
      }
    }
    function clearMarker() {
      if (insertionMarker && insertionMarker.parentElement) insertionMarker.parentElement.removeChild(insertionMarker);
    }

    function dragStart(e) {
      dragged = e.target;
      if (!dragged) return;
      if (dragged.classList.contains('pool-task')) dragSource = 'pool';
      else if (dragged.classList.contains('assigned-task')) dragSource = 'assigned';
      else dragSource = null;
      // Give a bit of transparency while dragging
      setTimeout(() => dragged && (dragged.style.opacity = '0.6'), 0);
    }

    function dragEnd(e) {
      if (dragged) dragged.style.opacity = '';
      dragged = null; dragSource = null;
      clearMarker();
    }

    // keyboard: Enter on pool to assign to end (if space), Arrow up/down/delete on assigned
    function poolKeyDown(e) {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        const el = e.currentTarget;
        // attempt to append to schedule
        const assignedCount = document.querySelectorAll('.assigned-task').length;
        if (assignedCount >= 3) { showToast('You may only assign up to 3 optional tasks.'); return; }
        const scheduleList = document.getElementById('scheduleList');
        if (!scheduleList) return;
        const newEl = document.createElement('div');
        newEl.className = 'task-item assigned-task';
        newEl.textContent = el.textContent;
        newEl.draggable = true;
        newEl.dataset.index = el.dataset.index;
        newEl.tabIndex = 0;
        newEl.onkeydown = assignedKeyDown;
        newEl.ondragstart = dragStart;
        newEl.ondragend = dragEnd;
        // animate append
        newEl.style.opacity = 0; newEl.style.transform = 'translateY(6px)';
        scheduleList.appendChild(newEl);
        requestAnimationFrame(() => { newEl.style.transition = 'opacity 160ms ease, transform 160ms ease'; newEl.style.opacity = 1; newEl.style.transform = ''; });
        el.classList.add('used');
        saveAssignments();
        checkReady();
      }
    }

    function assignedKeyDown(e) {
      const el = e.currentTarget;
      if (!el) return;
      if (e.key === 'Delete' || e.key === 'Backspace') {
        // unassign
        const idx = el.dataset.index;
        const poolTask = document.querySelector(`.pool-task[data-index='${idx}']`);
        if (poolTask) poolTask.classList.remove('used');
        if (el.parentElement) el.parentElement.removeChild(el);
        saveAssignments();
        checkReady();
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        const prev = el.previousElementSibling;
        if (prev) el.parentElement.insertBefore(el, prev);
        saveAssignments();
      } else if (e.key === 'ArrowDown') {
        e.preventDefault();
        const next = el.nextElementSibling;
        if (next) el.parentElement.insertBefore(next, el);
        saveAssignments();
      }
    }

    // list drag handlers: compute insertion point and show marker
    function listDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      const list = e.currentTarget;
      ensureMarker();

      // compute insertion spot skipping any existing marker nodes
      const children = Array.from(list.children).filter(c => !c.classList || !c.classList.contains('insertion-marker'));
      let insertBeforeEl = null;
      for (const child of children) {
        const rect = child.getBoundingClientRect();
        const mid = rect.top + rect.height / 2;
        if (e.clientY < mid) { insertBeforeEl = child; break; }
      }

      // place marker at computed spot
      clearMarker();
      if (insertBeforeEl) list.insertBefore(insertionMarker, insertBeforeEl);
      else list.appendChild(insertionMarker);
    }

    function listDragLeave(e) {
      // remove the insertion marker when leaving the list
      clearMarker();
    }

    function listDrop(e) {
      e.preventDefault();
      const list = e.currentTarget;
      if (!dragged) { clearMarker(); return; }

      // If dragging from pool, ensure max 3 assigned
      const assignedCount = document.querySelectorAll('.assigned-task').length;
      if (dragSource === 'pool' && assignedCount >= 3) {
        // simple feedback via toast
        showToast('You may only assign up to 3 optional tasks.');
        dragEnd();
        return;
      }

      // Use the marker position (if present) as the insertion point
      const marker = insertionMarker && insertionMarker.parentElement === list ? insertionMarker : null;

      if (dragSource === 'pool') {
        // create a new assigned element
        const newEl = document.createElement('div');
        newEl.className = 'task-item assigned-task';
        newEl.textContent = dragged.textContent;
        newEl.draggable = true;
        newEl.dataset.index = dragged.dataset.index; // preserve misery index
        newEl.tabIndex = 0;
        newEl.onkeydown = assignedKeyDown;
        newEl.ondragstart = dragStart;
        newEl.ondragend = dragEnd;
        // animate insertion
        newEl.style.opacity = 0; newEl.style.transform = 'translateY(6px)';
        if (marker) list.insertBefore(newEl, marker);
        else list.appendChild(newEl);
        requestAnimationFrame(() => { newEl.style.transition = 'opacity 160ms ease, transform 160ms ease'; newEl.style.opacity = 1; newEl.style.transform = ''; });
        // mark pool item used
        dragged.classList.add('used');
        // persist assignments
        saveAssignments();
      } else if (dragSource === 'assigned') {
        // moving an existing assigned element within the list
        // if marker is directly after dragged, nothing to do
        if (marker && marker.nextSibling === dragged) { dragEnd(); return; }
        if (marker) list.insertBefore(dragged, marker);
        else list.appendChild(dragged);
      }

      clearMarker();
      checkReady();
      saveAssignments();
    }

    function dropToPool(e) {
      e.preventDefault();
      const pool = e.currentTarget;
      if (!dragged) return;
      // if removing an assigned task, remove it and unmark pool item
      if (dragged.classList.contains('assigned-task')) {
        const idx = dragged.dataset.index;
        // find pool-task with same index
        const poolTask = document.querySelector(`.pool-task[data-index='${idx}']`);
        if (poolTask) poolTask.classList.remove('used');
        // remove the assigned element from schedule
        if (dragged.parentElement) dragged.parentElement.removeChild(dragged);
        checkReady();
        saveAssignments();
      }
      dragEnd();
    }

    // show a small toast message
    let toastTimer = null;
    function showToast(msg, ms = 1800) {
      const t = document.getElementById('toast');
      if (!t) return; t.textContent = msg; t.classList.add('active');
      if (toastTimer) clearTimeout(toastTimer);
      toastTimer = setTimeout(() => { t.classList.remove('active'); toastTimer = null; }, ms);
    }

    function checkReady() {
      const assigned = document.querySelectorAll('.assigned-task').length;
      document.getElementById('submitBtn').disabled = assigned < 3;
    }

    // persist assigned tasks per-demon in state and localStorage
    function saveAssignments() {
      if (!state.current) return;
      const assignedEls = Array.from(document.querySelectorAll('.assigned-task'));
      const arr = assignedEls.map(el => el.dataset.index);
      state.assignments[state.current.id] = arr;
      // only persist if user opted in
      if (localStorage.getItem('rememberAssignments') === 'true') {
        try { localStorage.setItem('assignments', JSON.stringify(state.assignments)); } catch (e) { /* ignore */ }
      }
    }

    function loadAssignments() {
      try {
        const raw = localStorage.getItem('assignments');
        if (raw) state.assignments = JSON.parse(raw);
      } catch (e) { state.assignments = {}; }
    }

    function markPoolUsed() {
      // mark pool tasks used based on current state's saved assignments
      const d = state.current;
      if (!d) return;
      // clear any used flags first
      document.querySelectorAll('.pool-task').forEach(t => t.classList.remove('used'));
      const arr = state.assignments[d.id] || [];
      arr.forEach(idx => {
        const poolTask = document.querySelector(`.pool-task[data-index='${idx}']`);
        if (poolTask) poolTask.classList.add('used');
      });
    }

    // (remember-schedule toggles removed in reverted UI)

    document.getElementById('submitBtn').onclick = () => {
      if (!state.current) return;
      // ensure latest assignments are saved for this demon
      saveAssignments();
      const d = state.current;
      // compute this demon's misery from saved assignment indices
      let misery = 0;
      const assignedIndices = state.assignments[d.id] || [];
      assignedIndices.forEach(idx => { const i = Number(idx); misery += (d.misery[i] || 0); });
      const avg = Math.round((misery / 30) * 100);
      // lock this demon so it can't be edited again
      state.locked[d.id] = true;
      document.querySelectorAll('.demon-item').forEach(el => { if (el.innerText.includes(d.name)) el.classList.add('locked'); });

      // count how many demons have been submitted (locked)
      const lockedCount = Object.values(state.locked).filter(Boolean).length;
      if (lockedCount < demons.length) {
        // not all schedules submitted yet â€” show the single-demon report and continue
        showModal(`${d.name}'s Shift Report`, `Misery Index: ${misery} / 30<br>Efficiency: ${avg}%<br><br>${lockedCount} of ${demons.length} schedules submitted. Continue scheduling remaining demons.`);
        return;
      }

      // all demons submitted â€” compute total misery across the three schedules
      let totalMisery = 0;
      demons.forEach(dd => {
        const arr = state.assignments[dd.id] || [];
        arr.forEach(idx => { totalMisery += (dd.misery[Number(idx)] || 0); });
      });
      const totalMax = demons.length * 30; // each demon has a max of 30
      const totalPct = Math.round((totalMisery / totalMax) * 100);

      // flag for advancing to Shift 2 after closing the modal
      try { window._advanceToShift2 = true; } catch (e) { /* ignore */ }
      showModal(`Shift Complete â€” Total Misery`, `Total Misery: ${totalMisery} / ${totalMax}<br>Overall Efficiency: ${totalPct}%<br><br>Report filed to Central Torment Division. Skipping break â€” proceed to Shift 2.`);
    };

    function showModal(title, body) {
      document.getElementById('modalTitle').innerHTML = title;
      document.getElementById('modalBody').innerHTML = body;
      document.getElementById('modal').classList.add('active');
    }
    function closeModal() {
      document.getElementById('modal').classList.remove('active');
      // If submit flagged advancement to Shift 2, navigate when the player closes the modal
      try {
        if (window._advanceToShift2) {
          window._advanceToShift2 = false;
          // navigate to the second shift page (skip break)
          window.location.href = 'work_shift2.html';
        }
      } catch (e) { /* ignore navigation errors in some contexts */ }
    }

    // Welcome modal handlers
    function showWelcomeModal() {
      document.getElementById('welcomeModal').classList.add('active');
    }
    function closeWelcomeModal() {
      const cb = document.getElementById('hideWelcomeCheckbox');
      if (cb && cb.checked) localStorage.setItem('hideWelcome', 'true');
      document.getElementById('welcomeModal').classList.remove('active');
    }
    init();

    /* -------------------- Email app simulation -------------------- */
    const sampleEmails = [
      { id: 1, from: 'Central Torment', subject: 'Mandatory Training: Soul Filing', preview: 'New regulation requires every demon to complete online training by Friday.', body: 'All demons must complete the new mandatory training. Failure to comply will result in additional paperwork and bureaucratic reassignment.', time: '9:12 AM', unread: true },
      { id: 2, from: 'HR Dept.', subject: 'PTO Request Denied', preview: 'Your request for time off during the eclipse has been denied.', body: 'After review, the PTO request was denied due to operational needs during the eclipse week.', time: 'Yesterday', unread: false },
      { id: 3, from: 'IT Support', subject: 'Wi-Fi Maintenance', preview: 'We will be performing maintenance tonight at 11pm. Expect downtime up to 30 minutes.', body: 'Routine maintenance scheduled. Please save your work.', time: '2 days ago', unread: false },
      { id: 4, from: 'Facilities', subject: 'Coffee Machine Outage (again)', preview: 'The infernal espresso conduit is currently clogged with brimstone.', body: 'Facilities reports the espresso conduit is clogged. Please refrain from attempting to praise the machine â€” it is not sentient (yet). ETA repair: tomorrow.', time: '3 hours ago', unread: false },
      { id: 5, from: 'Payroll', subject: 'Payroll Adjustment: Soul Deduction', preview: 'There was an adjustment to payroll this period affecting souls and benefits.', body: 'An automated deduction affected several soul-based benefits. If your essence balance seems low, file a ticket. Do not contact the auditor directly.', time: 'Yesterday', unread: false }
    ];

    function renderEmailInbox() {
      const list = document.getElementById('emailList');
      list.innerHTML = '';
      sampleEmails.forEach(e => {
        const item = document.createElement('div');
        item.className = 'email-item' + (e.unread ? ' unread' : '') + (e.id === selectedEmailId ? ' selected' : '');
        item.tabIndex = 0;
        item.dataset.id = e.id;
        item.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;"><div><div style='font-weight:700'>${e.from}</div><div style='font-size:13px;color:#d1c0f8'>${e.subject}</div><div style='font-size:12px;color:#9ca3af'>${e.preview}</div></div><div style='font-size:12px;color:#9ca3af'>${e.time}</div></div>`;
        item.onclick = () => openEmail(e.id);
        item.onkeydown = (ev) => { if (ev.key === 'Enter') openEmail(e.id); };
        list.appendChild(item);
      });
      // if an email is selected, render preview, otherwise show a placeholder
      const preview = document.getElementById('emailPreview');
      if (selectedEmailId) {
        const e = sampleEmails.find(s => s.id === selectedEmailId);
        if (e) {
          document.getElementById('previewHeader').textContent = `${e.subject} â€” ${e.from}`;
          document.getElementById('previewBody').textContent = e.body;
        }
      } else {
        document.getElementById('previewHeader').textContent = 'No message selected';
        document.getElementById('previewBody').textContent = 'Choose a message from the list to view the full content.';
      }
      updateUnreadBadge();
    }

    let selectedEmailId = null;
    function openEmail(id) {
      const e = sampleEmails.find(x => x.id === id);
      if (!e) return;
      // mark read and select
      e.unread = false;
      selectedEmailId = id;
      document.getElementById('previewHeader').textContent = `${e.subject} â€” ${e.from}`;
      document.getElementById('previewBody').textContent = e.body;
      renderEmailInbox();
    }

    function updateUnreadBadge() {
      const count = sampleEmails.reduce((acc, m) => acc + (m.unread ? 1 : 0), 0);
      const badge = document.getElementById('unreadBadge');
      if (!badge) return;
      if (count > 0) { badge.style.display = 'inline-block'; badge.textContent = count; badge.setAttribute('aria-label', `${count} unread messages`); }
      else { badge.style.display = 'none'; }
      // add accessible title to icon
      const icon = document.getElementById('emailIcon'); if (icon) icon.title = `Open Mail (${count} unread)`;
    }

    /* ------------------ Drag / Resize for Inbox ------------------ */
    (function setupDragResize() {
      const panel = document.getElementById('emailInbox');
      const header = panel.querySelector('.email-inbox-header');
      const handle = document.getElementById('resizeHandle');
      let drag = null; // {startX,startY,startLeft,startTop}
      let resize = null; // {startX,startY,startW,startH}

      // restore saved position/size
      try {
        const saved = JSON.parse(localStorage.getItem('emailPanelPrefs') || '{}');
        if (saved.left != null) { panel.style.left = saved.left; panel.style.top = saved.top; panel.style.right = 'auto'; panel.style.bottom = 'auto'; }
        if (saved.width) panel.style.width = saved.width;
        if (saved.height) panel.style.height = saved.height;
      } catch (e) { /* ignore */ }

      function startDrag(e) {
        if (e.button === 2) return; // ignore right-click
        const rect = panel.getBoundingClientRect();
        const clientX = (e.touches ? e.touches[0].clientX : e.clientX);
        const clientY = (e.touches ? e.touches[0].clientY : e.clientY);
        drag = { startX: clientX, startY: clientY, startLeft: rect.left, startTop: rect.top };
        // switch to left/top positioning so we can move freely
        panel.style.left = rect.left + 'px'; panel.style.top = rect.top + 'px'; panel.style.right = 'auto'; panel.style.bottom = 'auto';
        document.addEventListener('mousemove', onDrag);
        document.addEventListener('touchmove', onDrag, { passive: false });
        document.addEventListener('mouseup', endDrag);
        document.addEventListener('touchend', endDrag);
      }
      function onDrag(e) {
        if (!drag) return;
        const clientX = (e.touches ? e.touches[0].clientX : e.clientX);
        const clientY = (e.touches ? e.touches[0].clientY : e.clientY);
        const dx = clientX - drag.startX; const dy = clientY - drag.startY;
        panel.style.left = Math.max(8, drag.startLeft + dx) + 'px';
        panel.style.top = Math.max(8, drag.startTop + dy) + 'px';
        e.preventDefault && e.preventDefault();
      }
      function endDrag() {
        if (!drag) return; drag = null;
        document.removeEventListener('mousemove', onDrag);
        document.removeEventListener('touchmove', onDrag);
        document.removeEventListener('mouseup', endDrag);
        document.removeEventListener('touchend', endDrag);
        // persist
        try { localStorage.setItem('emailPanelPrefs', JSON.stringify(Object.assign(JSON.parse(localStorage.getItem('emailPanelPrefs') || '{}'), { left: panel.style.left, top: panel.style.top }))); } catch (e) { }
      }

      function startResize(e) {
        const rect = panel.getBoundingClientRect();
        const clientX = (e.touches ? e.touches[0].clientX : e.clientX);
        const clientY = (e.touches ? e.touches[0].clientY : e.clientY);
        resize = { startX: clientX, startY: clientY, startW: rect.width, startH: rect.height };
        document.addEventListener('mousemove', onResize);
        document.addEventListener('touchmove', onResize, { passive: false });
        document.addEventListener('mouseup', endResize);
        document.addEventListener('touchend', endResize);
        e.preventDefault && e.preventDefault();
      }
      function onResize(e) {
        if (!resize) return;
        const clientX = (e.touches ? e.touches[0].clientX : e.clientX);
        const clientY = (e.touches ? e.touches[0].clientY : e.clientY);
        const dx = clientX - resize.startX; const dy = clientY - resize.startY;
        const newW = Math.max(360, resize.startW + dx);
        const newH = Math.max(260, resize.startH + dy);
        panel.style.width = newW + 'px'; panel.style.height = newH + 'px';
        e.preventDefault && e.preventDefault();
      }
      function endResize() {
        if (!resize) return; resize = null;
        document.removeEventListener('mousemove', onResize);
        document.removeEventListener('touchmove', onResize);
        document.removeEventListener('mouseup', endResize);
        document.removeEventListener('touchend', endResize);
        // persist width/height
        try { const prefs = JSON.parse(localStorage.getItem('emailPanelPrefs') || '{}'); prefs.width = panel.style.width; prefs.height = panel.style.height; localStorage.setItem('emailPanelPrefs', JSON.stringify(prefs)); } catch (e) { }
      }

      header.addEventListener('mousedown', startDrag);
      header.addEventListener('touchstart', startDrag, { passive: false });
      handle.addEventListener('mousedown', startResize);
      handle.addEventListener('touchstart', startResize, { passive: false });
    })();

    /* -------------- Incoming message simulation & notifications -------------- */
    (function setupIncoming() {
      // Larger, funnier set of senders and subject/body templates to feel like an actual (hellish) office
      const senders = [
        'Central Torment', 'HR Dept.', 'IT Support', 'Payroll', 'Facilities', 'Cafeteria', 'Onboarding', 'Security', 'Vendor Relations', 'Scheduling'
      ];
      const subjects = [
        'All-hands: Departmental Purge',
        'Expense Report: Your pen is on fire',
        'Mandatory Etiquette Training: Torture Techniques',
        'Coffee Machine Outage',
        'Re: Re: Re: TPS Forms',
        'Payroll Adjustment: Soul Deduction',
        'Fire Safety Drill â€” Definitely Not a Drill',
        'Visitor Parking Allocation for Lesser Demons',
        'Interdepartmental Memo: Stop Summoning Pets',
        'Reminder: Annual Branding of Souls due Friday',
        'Meeting Invite: Discussing the Heat Map',
        'Security Alert: Portal left unlocked',
        'Onboarding: New Minion Paperwork'
      ];

      const previews = [
        'Please review and comply by end of week.',
        'This affects your department â€” action required.',
        'Short notice maintenance; expect brief outages.',
        'You are scheduled for a mandatory in-person retraining.',
        'FYI â€” payroll looked strange this morning.'
      ];

      const bodies = [
        'Please see attached ritual and complete steps 1â€“7. Failure to complete will generate additional paperwork.',
        'Facilities notes a small blaze near the break room. Do not attempt to extinguish with holy water.',
        'Payroll discovered an unexpected soul deduction. If you believe this is an error, file ITAR (Infernal Tax Appeals Request).',
        'We will be holding a workshop on proper whistleblowing procedures next Thursday. Snacks provided (sacrificial).',
        'Reminder: Do not leave summoning circles unattended. HR will not cover stray familiars.'
      ];

      let nextId = Math.max(0, ...sampleEmails.map(e => e.id)) + 1;

      function rand(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

      function makeMessage() {
        const from = rand(senders);
        const subject = rand(subjects);
        const preview = `${subject} â€” ${rand(previews)}`;
        const body = `${subject}\n\n${rand(bodies)}\n\nRegards,\n${from}`;
        return { id: nextId++, from, subject, preview, body, time: 'Just now', unread: true };
      }

      function showNotify(text) {
        const n = document.getElementById('mailNotify');
        if (!n) return; n.innerHTML = text; n.classList.add('show'); n.setAttribute('aria-hidden', 'false');
        setTimeout(() => { n.classList.remove('show'); n.setAttribute('aria-hidden', 'true'); }, 4800);
      }

      function incomingMessageSimulation() {
        const m = makeMessage(); sampleEmails.unshift(m);
        // keep inbox reasonably sized
        if (sampleEmails.length > 80) sampleEmails.length = 80;
        updateUnreadBadge(); renderEmailInbox();
        // animate badge
        const badge = document.getElementById('unreadBadge'); if (badge) { badge.classList.remove('pulse'); void badge.offsetWidth; badge.classList.add('pulse'); }
        // show small notification (brief, informative)
        showNotify(`<strong>${m.from}</strong><div style="font-size:13px;color:#dcd0f8">${m.subject}</div>`);
      }

      // schedule: first message after ~20-40s, then every ~30-90s (quieter than before)
      setTimeout(function scheduleNext() { incomingMessageSimulation(); const next = 30000 + Math.random() * 60000; setTimeout(scheduleNext, next); }, 20000 + Math.random() * 20000);
    })();

    function toggleEmailInbox(show) {
      const panel = document.getElementById('emailInbox');
      if (!panel) return;
      const isActive = panel.getAttribute('aria-hidden') === 'false';
      const shouldOpen = typeof show === 'boolean' ? show : !isActive;
      if (shouldOpen) {
        panel.style.display = 'flex'; panel.setAttribute('aria-hidden', 'false');
        // if nothing is selected, pick the first unread or first message
        if (!selectedEmailId) {
          const firstUnread = sampleEmails.find(m => m.unread);
          selectedEmailId = firstUnread ? firstUnread.id : (sampleEmails.length ? sampleEmails[0].id : null);
        }
        renderEmailInbox();
      } else {
        panel.style.display = 'none'; panel.setAttribute('aria-hidden', 'true');
      }
    }

    // wire up icon
    document.getElementById('emailIcon').addEventListener('click', () => toggleEmailInbox(true));
    document.getElementById('closeEmail').addEventListener('click', () => toggleEmailInbox(false));
    document.getElementById('composeBtn').addEventListener('click', () => showToast('Compose not implemented in this demo'));
    // initial badge update
    updateUnreadBadge();

  </script>
</body>

</html>